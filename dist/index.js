import{useEffect as e,useImperativeHandle as t,useRef as n,useState as r}from"react";import{Fragment as i,jsx as a,jsxs as o}from"react/jsx-runtime";function s({allowEditCellOverflow:e,ariaLabel:t,children:n,classNames:r,columnDef:i,columnIndex:o,columnIndexRelative:s,endColumnIndex:c,endRowIndex:l,isEditing:u,isFocused:d,position:f,rowIndex:p,selected:m=!1,startColumnIndex:h,startRowIndex:g,styles:_,virtualRowIndex:v}){if(f===void 0)return console.warn(`Column definition not found.`),null;let y=c-h-(o-h),b=l-g+1-(p-g),x=`${r?.base??``}${m?` ${r?.selected}`:``}${d?` ${r?.focused}`:``}${u?` ${r?.edited}`:``}`,S=typeof _==`function`?_(n):_;return a(`div`,{"aria-label":t,className:`cantal-cell-base${d?` cantal-cell-focused`:``}${i.pinned?` cantal-cell-pinned-${i.pinned}`:``}${m?` cantal-cell-selected`:``}${u?` cantal-cell-editing`:``}${x.length?` ${x}`:``}`,"data-col-idx":o,"data-field":i.field,"data-row-idx":g,"data-row-end-idx":l,role:`gridcell`,style:{...S.base,...m?S.selected:{},...d?S.focused:{},...u?S.edited:{},gridColumnStart:f.pinnedIndex,gridColumnEnd:f.pinnedIndexEnd+y,gridRowStart:v+1,gridRowEnd:v+1+b,...e&&u?{overflow:`visible`,zIndex:0}:{}},children:n})}function c(e,t,n){let r=l(e,t,n).map(e=>e.join(`	`)).join(`
`);navigator.clipboard.writeText(r)}function l(e,t,n){if(n===null||n.length===0)return[];let r=u(n),[i,a]=r.shape(),o=Array.from(Array(i+1),()=>Array(a+1).fill(`\\0`));for(let i=r.fromRow;i<=r.toRow;i++){let a=e[i],s=i-r.fromRow;if(a)for(let e=r.fromColumn;e<=r.toColumn;e++){let c=e-r.fromColumn;if(n.every(t=>!t.contains(i,e)))continue;let l=t[e];if(!(!l||!o[s])){if(l?.valueRenderer){let e=l.valueRenderer({columnDef:l,data:a,value:a[l.field]});if(typeof e!=`object`){o[s][c]=e;continue}}o[s][c]=a[l.field]??``}}}return o}function u(e){return e.slice(1).reduce((e,t)=>e.merge(t),e[0])}function d({canvasWidth:t,columnGap:l,columnSpans:u,containerHeight:d,data:y,editCell:b,focusedCell:x=null,handleContextMenu:O,handleDoublePointerDown:oe,handleEdit:se,handleEditCellChange:j,handleFocusedCellChange:M,handleKeyDown:ce,handlePointerDown:le,handleScroll:ue,handleSelection:N,headerViewportRef:de,leafColumns:P,overscanColumns:fe,overscanRows:pe,positions:F,rowGap:I,rowHeight:L=27,rowId:R,selectedRanges:z,selectionFollowsFocus:me=!1,setState:he,showSelectionBox:ge,styles:V,virtual:H,visibleColumnEnd:_e,visibleColumnStart:ve}){let U=n(null),ye=n(null),be=n(null),[W,xe]=r(()=>H===!0||H===`rows`?S(0,Math.floor(window.innerHeight/L)):S(0,y.length)),[G,K]=r(void 0),[q,Ce]=r(void 0),[J,we]=r(void 0);e(()=>{U.current&&de.current&&(U.current.style.height=`${d-de.current.offsetHeight}px`)},[d]),e(()=>{!b&&x&&be.current&&be.current.focus()},[b,x]),e(()=>{if(!x||!U.current)return;let e=P[x?.columnIndex];if(e===void 0)return;let t=Te(U.current,P,l),n=P.reduce((e,t,n)=>n<x.columnIndex?e+t.width+I:e,0),r=n+e.width,i=L*x.rowIndex+x.rowIndex*I,a=i+L;n<t.left?U.current.scrollLeft=n-t.leftOffset:r>t.right-t.rightOffset&&(U.current.scrollLeft=r-t.width+t.rightOffset),i<t.top?U.current.scrollTop=i:a>t.bottom&&(U.current.scrollTop=a-t.height)},[l,x,P.map(e=>e.field).join(`-`)]),e(()=>{function e(e){let t=f(e),n=ye.current?p(e,ye.current):void 0;!t||!G||(N?.([h(G.rowIndex,G.columnIndex,t.rowIndex,t.columnIndex)],n,e),ge&&n!==void 0&&we(n))}function t(e){N?.(z,void 0,e),K(void 0),Ce(void 0),we(void 0)}return G&&(window.addEventListener(`pointermove`,e),window.addEventListener(`pointerup`,t)),function(){window.removeEventListener(`pointermove`,e),window.removeEventListener(`pointerup`,t)}},[z,ge,G]);function Te(e,t,n){let{offsetHeight:r,offsetWidth:i,scrollLeft:a,scrollTop:o}=e,s=t.filter(e=>e.pinned===`start`),c=t.filter(e=>e.pinned===`end`),l=Se(s,n),u=Se(c,n),d=s.length?l+a:a,f=c.length?a+i-u:a+i,p=e.getBoundingClientRect();return{bottom:o+r,height:r,left:d,leftOffset:l,right:f,rightOffset:u,top:o,width:p.width}}let Y=P.filter(e=>e.pinned===`start`),X=P.filter(e=>e.pinned===`end`),Ee=P.filter(e=>e.pinned!==`start`&&e.pinned!==`end`);function De(){if(U.current&&(H===!0||H===`columns`)){let{offsetWidth:e,scrollLeft:t}=U.current,n=t+Y.reduce((e,t)=>e+t.width,0)+Math.max(Y.length-1,0)*l,r=Math.max(t,t+e-(X.reduce((e,t)=>e+t.width,0)+Math.max(X.length-1,0)*l)),i=Oe(r),a=i.findIndex(e=>e>n),o=Math.max((a===-1?0:a)-fe,0),s=i.findIndex(e=>e>r);return[o,Math.min((s===-1?P.length-1:s)+fe,P.length-1)+1]}return[0,P.length]}function Oe(e){let t=[],n=0;for(let r of P){if(n>e)break;t.push(n+r.width+l),n+=r.width+l}return t}function ke(){if(U.current&&(H===!0||H===`rows`)){let{scrollTop:e,offsetHeight:t}=U.current,n=L+I;return S(Math.max(Math.floor((e+I)/n)-pe,0),Math.min(Math.floor((e+t)/n)+pe,y.length-1)+1)}return S(0,y.length)}function Ae(){c(y,P,z)}function je(){navigator.clipboard.readText().then(e=>{se(v(_(e),y,P,z,x,u),P)})}function Me(e){if(!x)return;let t=P[x.columnIndex];t&&(ce({e,cell:x,columnDef:t,defaultHandler:()=>Ne(e)}),e.stopPropagation())}function Ne(e){if([`ArrowUp`,`ArrowDown`,`ArrowLeft`,`ArrowRight`].includes(e.key)){e.preventDefault();let t=e.key.replace(`Arrow`,``).toLowerCase();e.shiftKey&&x&&z&&z.length>0&&N?N([g(e.key,x,z[0],y,P)],void 0,e):Le(e,t)}else e.key===`Tab`?(b&&Fe(),e.preventDefault(),Le(e,e.shiftKey?`left`:`right`,!0)):e.key===`Escape`?(b&&Ie(),e.preventDefault()):e.key===`Enter`?(Fe(),e.preventDefault(),Le(e,e.shiftKey?`up`:`down`)):e.key===`c`&&(e.metaKey||e.ctrlKey)?(e.preventDefault(),Ae()):e.key===`v`&&(e.metaKey||e.ctrlKey)?je():re(e)||e.key===`Backspace`||e.key===`Delete`?Pe(x,``):(e.key===`F2`||e.key===`u`&&e.ctrlKey)&&Pe(x,void 0,!1)}function Pe(e,t,n){if(!e)return;let r=y[e.rowIndex],i=P[e.columnIndex];if(!r||!i)return;let a=u?B(k(r[u],e.columnIndex),i):i,o={columnIndex:T(e.columnIndex,r,u),rowIndex:C(e.rowIndex,e.columnIndex,y,a,u)};!ie(o,r,a)||A({columnIndex:o.columnIndex,rowIndex:o.rowIndex},b)||j({...o,selectInitialValue:n??t===void 0,value:t??y[o.rowIndex][a.field]})}function Fe(e){if(!b)return;let t=y[b.rowIndex],n=P[b.columnIndex];if(!n||!t)return;let r=u?B(k(t[u],b.columnIndex),n):n;j(void 0),se({[R?t[R]:b.rowIndex]:{[r.field]:e===void 0?r.valueParser(b.value):r.valueParser(e)}},P)}function Ie(){b&&j(void 0)}function Le(e,t,n=!1){if(!x)return!1;let r=P[x.columnIndex];if(!r)return!1;if(t===`up`){let t=C(x.rowIndex-1,x.columnIndex,y,r,u);if(x.rowIndex===0)return!1;let n={...x,rowIndex:t};M(n,e),Z(n,e)}else if(t===`down`){let t=w(x.rowIndex,x.columnIndex,y,r,u);if(t>=y.length-1)return!1;let n={...x,rowIndex:t+1};M(n,e),Z(n,e)}else if(t===`left`){let t=T(x.columnIndex-1,y[x.rowIndex],u);if(x.columnIndex===0)if(n){if(x.rowIndex===0)return!1;let n={...x,columnIndex:T(P.length-1,y[x.rowIndex-1],u),rowIndex:C(x.rowIndex-1,t,y,r,u)};return M(n,e),Z(n,e),!0}else return!1;let i={...x,columnIndex:t};M(i,e),Z(i,e)}else if(t===`right`){let t=T(x.columnIndex,y[x.rowIndex],u,`end`);if(t+1>P.length-1)if(n){if(x.rowIndex>=y.length-1)return!1;let t={columnIndex:0,rowIndex:x.rowIndex+1};return M(t,e),Z(t,e),!0}else return!1;if(t+1>P.length-1)return!1;let r={...x,columnIndex:t+1};M(r,e),Z(r,e)}return!0}function Z(e,t){if(me&&N){let n=p(t,ye.current);N(Re(h(e.rowIndex,e.columnIndex)),n,t)}}function Re(e){let t=P[e.fromColumn];if(!t)return[e];let n=T(e.fromColumn,y[e.fromRow],u),r=T(e.toColumn,y[e.fromRow],u,`end`);return[h(C(e.fromRow,e.fromColumn,y,t,u),n,w(e.toRow,e.fromColumn,y,t,u),r)]}function ze(e){e.persist?.(),e.preventDefault?.();let t=f(e),n=ae(e),r=n?p(e,ye.current):void 0;if(!t||!r&&n)return;let i=P[t.columnIndex];i&&(e.detail===2||e.type===`dblclick`?oe({e,cell:t,point:r,columnDef:i,defaultHandler:()=>Pe(t)}):n&&r&&le({e,cell:t,point:r,columnDef:i,defaultHandler:()=>Be(e,t,r)}))}function Be(e,t,n){if(!A(t,b)){if(b&&Fe(),e.shiftKey&&x&&z&&z.length>0&&N){N(Re(h(x.rowIndex,x.columnIndex).merge(h(t.rowIndex,t.columnIndex))),n,e);return}e.button===0&&!e.ctrlKey&&n&&(M(t,e,n),N&&n&&(K(t),Ce(n),Z(t,e)))}}function Ve(e){if(de.current&&(de.current.scrollLeft=e.currentTarget.scrollLeft),U.current&&(H===!0||H===`rows`)&&xe(ke()),U.current&&(H===!0||H===`columns`)){let[e,t]=De();he.setVisibleStartColumn(e),he.setVisibleEndColumn(t)}U.current&&ue({event:e,viewportElement:U.current})}let Q=S(ve,_e),He={overflow:`auto`,width:`inherit`},Ue={height:H===`rows`||H===!0?(L+I)*y.length-I:`auto`,width:t},We={...V.computed,backgroundColor:`var(--background-color)`,display:`grid`,gridAutoRows:L,gridTemplateColumns:`subgrid`,height:`max-content`,insetInline:0,position:`sticky`},Ge={...We,gridColumn:`1 / ${Y.length+1}`},Ke={...V.computed,display:`grid`,gridAutoRows:L,gridColumn:`${Y.length+1} / ${P.length-X.length+1}`,gridTemplateColumns:`subgrid`},qe={...We,gridColumn:`${P.length-X.length+1} / ${P.length+1}`},$=x?P[x.columnIndex]:void 0,Je=u?te(u,y,Q,W):void 0;return P.slice(ve,_e+1).some(e=>e.rowSpanning)&&ee(P,y,Q,W,Je),o(`div`,{className:`cantal-body-viewport`,onScroll:Ve,ref:U,style:He,children:[o(`div`,{className:`cantal-body-canvas`,onContextMenu:e=>{let t=f(e);if(!t||O===void 0)return;let n=P[t.columnIndex];n&&O({cell:t,columnDef:n,event:e,defaultHandler:()=>{m(z,t)||(M(t,e),Z(t,e))}})},onDoubleClick:e=>ze({...e,detail:2}),onKeyDown:Me,onPointerDown:ze,onPointerUp:e=>void 0,ref:ye,style:Ue,children:[x&&$&&a(`div`,{"aria-label":$.ariaCellLabel instanceof Function?$.ariaCellLabel({def:$,columnIndex:x.columnIndex,data:y[x.rowIndex],rowIndex:x.rowIndex,value:y[x.rowIndex]?y[x.rowIndex][$.field]:null}):$.ariaCellLabel,"aria-live":`polite`,className:`cantal-focused-cell`,ref:be,role:`gridcell`,style:{position:`fixed`,top:0,left:0,width:0,height:0,overflow:`hidden`},tabIndex:-1,children:y[x.rowIndex]?$.valueRenderer({columnDef:$,data:y[x.rowIndex],value:y[x.rowIndex][$.field]}):null}),y.length>0&&a(`div`,{className:`cantal-focus-sink`,style:{position:`fixed`,top:0,left:0,width:0,height:0,overflow:`hidden`},tabIndex:0}),a(`div`,{className:`cantal-body`,style:{display:`grid`,gridAutoRows:L,insetBlockStart:W[0]?W[0]*(L+I):0,...Y.concat(X).length>0?{height:`${L*W.length+I*W.length-1}px`}:{},...V.computed},children:Y.length>0||X.length>0?o(i,{children:[Y.length>0&&a(`div`,{className:`cantal-body-pinned-start`,style:Ge,children:W.map(e=>{let t=y[e];return Y.map((n,r)=>{let i=n,o=(H===!0||H===`columns`)&&Q[0]?r-Q[0]:r,c=(H===!0||H===`rows`)&&W[0]?e-W[0]:e,l=e,d=e;if(n.rowSpanning){if(c!==0&&E(n,t,y[e-1])&&!D(y[e-1],u,r))return null;l=C(e,r,y,n,u),d=w(e,r,y,n,u)}let f=r,p=r;if(u){if(r!==0&&D(t,u,r))return null;f=T(r,t,u),p=T(r,t,u,`end`),i=B(k(t[u],r,`from`),n)}let h=i.editor({columnDef:i,columnIndex:r,data:t,rowIndex:e,value:i.valueRenderer({columnDef:i,data:t,value:t[i.field]})}),g=A({columnIndex:r,rowIndex:e},b),_=ne(x,l,f,d,p);return a(s,{allowEditCellOverflow:i.allowEditCellOverflow,ariaLabel:typeof i.ariaCellLabel==`function`?i.ariaCellLabel({columnIndex:r,data:t,def:i,rowIndex:e,value:t[i.field]}):i.ariaCellLabel,classNames:typeof i.cellClassNames==`function`?i.cellClassNames(t,i,e,r):i.cellClassNames,columnDef:i,columnIndex:r,columnIndexRelative:o,endColumnIndex:p,endRowIndex:d,isEditing:g,isFocused:_,position:F.get(n),rowIndex:e,selected:m(z,{columnIndex:r,rowIndex:e}),startColumnIndex:f,startRowIndex:l,styles:typeof V.user?.cell==`function`?V.user.cell.bind(void 0,t,i,e,r):V.user?.cell??{},virtualRowIndex:c,children:g&&h?a(h,{columnDef:i,columnIndex:r,data:t,handleChange:e=>{b&&j({...b,selectInitialValue:!1,value:e})},rowIndex:e,selectInitialValue:b?.selectInitialValue,value:b?.value}):i.valueRenderer({columnDef:i,data:t,value:t[i.field]})},`${e}-${r}`)})})}),a(`div`,{className:`cantal-body-unpinned`,style:Ke,children:Ee.length>0&&W.map(e=>{let t=y[e];return Q.map(n=>{let r=Ee[n];if(!r)return null;let i=r,o=(H===!0||H===`columns`)&&Q[0]?n-Q[0]:n,c=(H===!0||H===`rows`)&&W[0]?e-W[0]:e,l=n+Y.length,d=e,f=e;if(r.rowSpanning){if(c!==0&&E(r,t,y[e-1])&&!D(y[e-1],u,l))return null;d=C(e,l,y,r,u),f=w(e,l,y,r,u)}let p=l,h=l;if(u){if(o!==0&&D(t,u,l))return null;p=T(l,t,u),h=T(l,t,u,`end`),i=B(k(t[u],l,`from`),r)}let g=i.editor({columnDef:i,columnIndex:l,data:t,rowIndex:e,value:i.valueRenderer({columnDef:i,data:t,value:t[i.field]})}),_=A({columnIndex:l,rowIndex:e},b),v=ne(x,d,p,f,h);return a(s,{allowEditCellOverflow:i.allowEditCellOverflow,ariaLabel:typeof i.ariaCellLabel==`function`?i.ariaCellLabel({columnIndex:l,data:t,def:i,rowIndex:e,value:t[i.field]}):i.ariaCellLabel,classNames:typeof i.cellClassNames==`function`?i.cellClassNames(t,i,e,l):i.cellClassNames,columnDef:i,columnIndex:l,columnIndexRelative:o,endColumnIndex:h,endRowIndex:f,isEditing:_,isFocused:v,position:F.get(r),rowIndex:e,selected:m(z,{columnIndex:l,rowIndex:e}),startColumnIndex:p,startRowIndex:d,styles:typeof V.user?.cell==`function`?V.user.cell.bind(void 0,t,i,e,l):V.user?.cell??{},virtualRowIndex:c,children:_&&g?a(g,{columnDef:i,columnIndex:l,data:t,handleChange:e=>{b&&j({...b,selectInitialValue:!1,value:e})},rowIndex:e,selectInitialValue:b?.selectInitialValue,value:b?.value}):i.valueRenderer({columnDef:i,data:t,value:t[i.field]})},`${e}-${l}`)})})}),X.length>0&&a(`div`,{className:`cantal-body-pinned-end`,style:qe,children:W.map(e=>{let t=y[e];return X.map((n,r)=>{let i=n,o=(H===!0||H===`columns`)&&Q[0]?r-Q[0]:r,c=(H===!0||H===`rows`)&&W[0]?e-W[0]:e,l=r+Y.length+Ee.length,d=e,f=e;if(n.rowSpanning){if(c!==0&&E(n,t,y[e-1])&&!D(y[e-1],u,l))return null;d=C(e,l,y,n,u),f=w(e,l,y,n,u)}let p=l,h=l;if(u){if(r!==0&&D(t,u,l))return null;p=T(l,t,u),h=T(l,t,u,`end`),i=B(k(t[u],l,`from`),n)}let g=i.editor({columnDef:i,columnIndex:l,data:t,rowIndex:e,value:i.valueRenderer({columnDef:i,data:t,value:t[i.field]})}),_=A({columnIndex:l,rowIndex:e},b),v=ne(x,d,p,f,h);return a(s,{allowEditCellOverflow:i.allowEditCellOverflow,ariaLabel:typeof i.ariaCellLabel==`function`?i.ariaCellLabel({columnIndex:r,data:t,def:n,rowIndex:e,value:t[n.field]}):i.ariaCellLabel,classNames:typeof i.cellClassNames==`function`?i.cellClassNames(t,i,e,l):i.cellClassNames,columnDef:i,columnIndex:l,columnIndexRelative:o,endColumnIndex:h,endRowIndex:f,isEditing:_,isFocused:v,position:F.get(n),rowIndex:e,selected:m(z,{columnIndex:l,rowIndex:e}),startColumnIndex:p,startRowIndex:d,styles:typeof V.user?.cell==`function`?V.user.cell.bind(void 0,t,i,e,l):V.user?.cell??{},virtualRowIndex:c,children:_&&g?a(g,{columnDef:i,columnIndex:l,data:t,handleChange:e=>{b&&j({...b,selectInitialValue:!1,value:e})},rowIndex:e,selectInitialValue:b?.selectInitialValue,value:b?.value}):i.valueRenderer({columnDef:i,data:t,value:t[i.field]})},`${e}-${l}`)})})})]}):a(i,{children:W.map(e=>{let t=y[e];return Q.map(n=>{let r=Ee[n];if(!t||!r)return null;let i=r,o=(H===!0||H===`columns`)&&Q[0]?n-Q[0]:n,c=(H===!0||H===`rows`)&&W[0]?e-W[0]:e,l=e,d=e;if(r.rowSpanning){if(c!==0&&E(r,t,y[e-1])&&!D(y[e-1],u,n))return null;l=C(e,n,y,r,u),d=w(e,n,y,r,u)}let f=n,p=n;if(u){if(o!==0&&D(t,u,n))return null;f=T(n,t,u),p=T(n,t,u,`end`),i=B(k(t[u],n,`from`),r)}let h=i.editor({columnDef:i,columnIndex:n,data:t,rowIndex:e,value:i.valueRenderer({columnDef:i,data:t,value:t[i.field]})}),g=A({columnIndex:n,rowIndex:e},b),_=ne(x,l,f,d,p);return a(s,{allowEditCellOverflow:i.allowEditCellOverflow,ariaLabel:typeof i.ariaCellLabel==`function`?i.ariaCellLabel({columnIndex:n,data:t,def:i,rowIndex:e,value:t[i.field]}):r.ariaCellLabel,classNames:typeof i.cellClassNames==`function`?i.cellClassNames(t,i,e,n):i.cellClassNames,columnDef:i,columnIndex:n,columnIndexRelative:o,endColumnIndex:p,endRowIndex:d,isEditing:g,isFocused:_,position:F.get(r),rowIndex:e,selected:m(z,{columnIndex:f,rowIndex:l}),startColumnIndex:f,startRowIndex:l,styles:typeof V.user?.cell==`function`?V.user.cell.bind(void 0,t,i,e,n):V.user?.cell??{},virtualRowIndex:c,children:g&&h?a(h,{columnDef:i,columnIndex:n,data:t,handleChange:e=>{b&&j({...b,selectInitialValue:!1,value:e})},rowIndex:e,selectInitialValue:b?.selectInitialValue,value:b?.value}):i.valueRenderer({columnDef:i,data:t,value:t[i.field]})},`${e}-${n}`)})})})})]}),ge&&q&&J&&a(`div`,{className:`cantal-selection-box`,style:{height:Math.abs(q.y-J.y),left:Math.min(q.x,J.x),top:Math.min(q.y,J.y),width:Math.abs(q.x-J.x)}})]})}function f(e){let t=e.target.closest(`[role=gridcell]`);if(!t)return null;let n=t.getAttribute(`data-col-idx`),r=t.getAttribute(`data-row-idx`);return!n||!r?null:{columnIndex:+n,rowIndex:+r}}function p(e,t){if(!(t===null||b(e)||x(e)))return{x:e.clientX-t.getBoundingClientRect().left,y:e.clientY-t.getBoundingClientRect().top}}function m(e,t){if(!t)return!1;for(let n of e)if(n.contains(t.rowIndex,t.columnIndex))return!0;return!1}function h(e,t,n,r){let i=r??t,a=n??e,o=Math.max(0,Math.min(t,i)),s=Math.max(0,Math.min(e,a)),c=Math.max(t,i),l=Math.max(e,a);function u(e,t){return e>=s&&e<=l&&t>=o&&t<=c}function d(){let e=m();return e[0]>0||e[1]>0||o===void 0&&c===void 0}function f(e){return s===e.fromRow&&o===e.fromColumn&&l===e.toRow&&c===e.toColumn}function p(e){return h(Math.min(s,e.fromRow),Math.min(o,e.fromColumn),Math.max(l,e.toRow),Math.max(c,e.toColumn))}function m(){return[l-s,c-o]}function g(){return`rows ${s} to ${l}; columns ${o} to ${c}`}return{contains:u,containsMultipleCells:d,equals:f,fromColumn:o,fromRow:s,merge:p,shape:m,toColumn:c,toRow:l,toString:g}}function g(e,t,n,r,i){return n===void 0?h(t.rowIndex,t.columnIndex):h(Math.min(r.length-1,n.fromRow+(n.fromRow>t.rowIndex?0:e===`ArrowUp`&&n.toRow===t.rowIndex?-1:e===`ArrowDown`&&n.toRow===t.rowIndex?1:0)),Math.min(i.length-1,n.fromColumn+(n.fromColumn>t.columnIndex?0:e===`ArrowLeft`&&n.toColumn===t.columnIndex?-1:e===`ArrowRight`&&n.toColumn===t.columnIndex?1:0)),Math.min(r.length-1,n.toRow+(n.toRow<=t.rowIndex?0:e===`ArrowUp`?-1:e===`ArrowDown`?1:0)),Math.min(i.length-1,n.toColumn+(n.toColumn<=t.columnIndex?0:e===`ArrowLeft`?-1:e===`ArrowRight`?1:0)))}function _(e){return e.split(`
`).map(e=>e.split(`	`))}function v(e,t,n,r,i,a,o){let s={},c=r[0];if(e.length===1&&e[0]?.length===1&&c&&c.containsMultipleCells()){let r=e[0]?.[0];if(r===void 0||y(r))return s;for(let e=c.fromRow;e<=c.toRow;e++){let i={},l=t[e];if(l){for(let t=c.fromColumn;t<=c.toColumn;t++){let a=n[t];if(!a)break;!ie({columnIndex:t,rowIndex:e},l,a)||D(l,o,t)||(i[a.field]=a.valueParser(r))}Object.keys(i).length>0&&(s[a?l[a]:e]=i)}}}else if(i){let r=0;for(let c=i.rowIndex;c<i.rowIndex+e.length;c++){let l=t[c],u=e[r];if(!l||!u)continue;let d={};for(let e=0;e<u.length;e++){let t=n[i.columnIndex+e];if(!t)break;!ie({columnIndex:i.columnIndex+e,rowIndex:c},l,t)||D(l,o,i.columnIndex+e)||(d[t.field]=t.valueParser(u[e]))}Object.keys(d).length>0&&(s[a?l[a]:c]=d),r++}}return s}function y(e){return e===`\\0`}function b(e){return e.key!==void 0}function x(e){return e.key===void 0&&e.pointerId===void 0}function S(e,t){return Array.from({length:t-e},(t,n)=>e+n)}function ee(e,t,n,r,i){let a={};for(let o of n){let n=e[o];if(!n)continue;let{field:s,rowSpanComparator:c,rowSpanning:l}=n;if(!l)continue;let u=r.at(-1);if(u)for(let e of r){if(a[e]??={},(i?.[e]?.[o]??0)>0){a[e][o]=1;continue}let r=1;for(;e+r<=u+1;){let l=t[e],d=t[e+r];if(l&&d&&c(n.valueRenderer({columnDef:n,data:l,value:l[s]}),n.valueRenderer({columnDef:n,data:d,value:d[s]}))&&[void 0,0].includes(i?.[e+r]?.[o])){if(e+r>u){a[e][o]=r;break}r+=1}else{a[e][o]=r;break}}}}return a}function te(e,t,n,r){let i={};for(let a of r){let r=t[a];if(!r||!n.at(-1))continue;let o=r[e];if(O(o))for(let e of n){i[a]??={};let t=o.find(t=>t.from<=e&&e<=t.to);t===void 0?i[a][e]=0:i[a][e]=t.to-e}}return i}function C(e,t,n,r,i){let a=e;for(;a>0;){let e=n[a],o=n[a-1],s=E(r,e,o),c=D(e,i,t);if(!s||c||s&&D(o,i,t))break;a--}return a}function w(e,t,n,r,i){let a=e;for(;a<n.length-1;){let e=n[a],o=n[a+1],s=E(r,o,e);if(D(e,i,t)||!s||s&&D(o,i,t))break;a++}return a}function T(e,t,n,r=`start`){if(!t||!n)return e;let i=t[n];if(!O(i))return e;let a=i.find(t=>t.from<=e&&e<=t.to);return a===void 0?e:r===`start`?a.from:a.to}function E(e,t,n){return e.rowSpanning&&t!==void 0&&n!==void 0&&e.rowSpanComparator(e.valueRenderer({columnDef:e,data:n,value:n[e.field]}),e.valueRenderer({columnDef:e,data:t,value:t[e.field]}))}function D(e,t,n){if(!e||!t)return!1;let r=e[t];return!!(O(r)&&r.find(e=>e.from<n&&n<=e.to))}function O(e){return Array.isArray(e)&&e.every(e=>typeof e.field==`string`&&typeof e.from==`number`&&typeof e.to==`number`)}function ne(e,t,n,r,i){if(!e)return!1;let a=n<=e.columnIndex&&e.columnIndex<=i,o=t<=e.rowIndex&&e.rowIndex<=r;return a&&o}function k(e,t,n=`in`){if(Array.isArray(e))return e.find(({from:e,to:r})=>n===`from`?t===e:e<=t&&t<=r)}function A(e,t){return e?.rowIndex===t?.rowIndex&&e?.columnIndex===t?.columnIndex}function re(e){return!e.metaKey&&!e.ctrlKey&&e.key.length===1}function ie(e,t,n){return typeof n.editable==`function`?n.editable({data:t,rowIndex:e.rowIndex,value:t[n.field]}):n.editable}function ae(e){return e.type.startsWith(`pointer`)}function oe({className:t,handleResize:n,handleResizeEnd:i,handleResizeStart:o,style:s={}}){let[c,l]=r(!1),[u,d]=r(null);function f(e){e.preventDefault(),l(!0),d(e.clientX),o()}function p(e){if(c&&(e.preventDefault(),u!==null)){let t=e.clientX-u;(t>0||t<0)&&n(t)}}function m(){c&&(l(!1),d(null),i())}return e(()=>(c&&(document.addEventListener(`pointermove`,p),document.addEventListener(`pointerup`,m)),function(){document.removeEventListener(`pointermove`,p),document.removeEventListener(`pointerup`,m)}),[c]),a(`div`,{...t?{className:t}:{},onPointerDown:f,style:s})}function se({className:e,handleSort:t,state:n}){function r(e){e.stopPropagation(),t(e)}return a(`button`,{"aria-label":`Sort: ${n.label}`,"aria-live":`assertive`,className:e,onPointerUp:r,children:n.symbol})}function j({classNames:e,columnDef:t,filterer:s=null,filters:c,handleFilter:l,handleResize:u,handleSort:d,position:f,sorts:p}){let[m,h]=r(0),g=n(null);function _(e){u(t,v(),e)}function v(){return typeof t.width==`string`?m:t.width}return f===void 0?(console.warn(`Column definition not found.`),null):o(`div`,{"aria-label":N(t.ariaHeaderCellLabel)?t.ariaHeaderCellLabel({def:t,position:f}):t.ariaHeaderCellLabel,className:`cantal-headercell${e?.container?` ${e.container}`:``}`,"data-column-end":f.pinnedIndexEnd,"data-column-start":f.pinnedIndex,"data-field":t.field,"data-row-end":f.depth+1,"data-row-start":f.level+1,ref:g,role:`columnheader`,style:{gridRowStart:f.level+1,gridColumnStart:f.pinnedIndex,gridRowEnd:f.depth+1,gridColumnEnd:f.pinnedIndexEnd,position:t.resizable?`sticky`:`static`},children:[o(`div`,{className:`cantal-headercell-content${e?.content?` ${e.content}`:``}`,children:[a(`div`,{className:`cantal-headercell-label${e?.label?` ${e.label}`:``}`,children:t.sortable&&t.sortStates.length?o(i,{children:[a(`span`,{className:`cantal-headercell-label-text`,children:t.title}),a(se,{className:`cantal-headercell-sorter${e?.sorter?` ${e.sorter}`:``}`,handleSort:e=>d(M(t.field,p,t.sortStates),e),state:le(t.field,p,t.sortStates)})]}):t.title}),t.filterable&&s&&a(s,{className:`cantal-headercell-filter${e?.filter?` ${e.filter}`:``}`,field:t.field,handleFilter:l,value:c[t.field]})]}),t.resizable&&a(oe,{className:`cantal-headercell-resizer${e?.resizer?` ${e.resizer}`:``}`,handleResize:_,handleResizeEnd:()=>h(0),handleResizeStart:()=>{if(typeof t.width==`string`&&g.current){let{width:e}=g.current.getBoundingClientRect();h(e)}}})]})}function M(e,t,n){let r=n.find(n=>n.label===t[e])??le(e,t,n),i=n.filter(e=>e.iterable!==!1);if(ue(i)){let t=ce(r,i);return{[e]:t}}return t}function ce(e,t){return t[(t.findIndex(t=>t.label===e?.label)+1)%t.length]?.label??t[0].label}function le(e,t,n){return n.find(n=>n.label===t[e])||n.find(e=>e.iterable===!1)||n[0]}function ue(e){return e.length>0}function N(e){return typeof e==`function`}function de({canvasWidth:e,columnDefs:t,filters:n,handleFilter:r,handleResize:s,handleSort:c,leafColumns:l,positions:u,ref:d,sorts:f,styles:p,visibleColumnEnd:m,visibleColumnStart:h,...g}){let _=l.filter(e=>e.pinned===`start`),v=l.filter(e=>e.pinned!==`start`&&e.pinned!==`end`),y=l.filter(e=>e.pinned===`end`);function b(e,n,r){if(e.subcolumns&&e.subcolumns.length>0){let n=H([e]),i=n.map(e=>e.width).reduce((e,t)=>e+t,0),a=i+r,o=n.map(e=>({...e,width:Math.max(e.minWidth,Math.round(e.width*a/i))})),c=n.reduce((e,n,r)=>o[r]===void 0?e:e.length===0?S(t,n,o[r]):S(e,n,o[r]),[]);s(e.field,a,c)}else if(e){let i=n+r,a=Math.max(e.minWidth,i),o=S(t,e,{...e,width:a});s(e.field,a,o)}}function x(e,n){let{columnEnd:r,columnStart:i,field:a,rowEnd:o,rowStart:s}=fe(e,[`column-end`,`column-start`,`field`,`row-end`,`row-start`]);if(a==null)return;let c=F(t,a);if(c===void 0)return;let l=n.replace(`on`,`handle`);(I(g,l)?g[l]:K)?.({columnDef:c,columnIndexEnd:Number(r),columnIndexStart:Number(i),defaultHandler:()=>{},e,rowIndexEnd:Number(o),rowIndexStart:Number(s)})}function S(e,t,n){let r=[],i=ee(n);for(let a of e)a.field===t.field?r.push(i):te(t)&&t.ancestors.map(e=>e.field).includes(a.field)?r.push({...a,subcolumns:S(a.subcolumns,t,n)}):r.push(a);return r}function ee(e){if(te(e)){let{ancestors:t,...n}=e;return n}return e}function te(e){return Object.hasOwn(e,`ancestors`)}let C={overflow:`hidden`,width:`inherit`},w={width:e},T={...p,backgroundColor:`var(--background-color)`,display:`grid`,gridTemplateColumns:`subgrid`,insetInline:0,position:`sticky`},E={...T,gridColumn:`1 / ${_.length+1}`},D={...p,display:`grid`,gridColumn:`${_.length+1} / ${l.length-y.length+1}`,gridTemplateColumns:`subgrid`},O={...T,gridColumn:`${l.length-y.length+1} / ${l.length+1}`};return a(`div`,{className:`cantal-header-viewport`,ref:d,style:C,children:a(`div`,{className:`cantal-header-canvas`,style:w,children:a(`div`,{className:`cantal-header`,onPointerDown:e=>x(e,`onPointerDown`),style:{display:`grid`,...p},children:_.length>0||y.length>0?o(i,{children:[_.length>0&&a(`div`,{className:`cantal-header-pinned-start`,style:E,children:P(_).map(e=>a(j,{classNames:typeof e.headerCellClassNames==`function`?e.headerCellClassNames({columnDef:e,position:u.get(e)}):e.headerCellClassNames,columnDef:e,filterer:e.filterer,filters:n,handleFilter:r,handleResize:b,handleSort:c,position:u.get(e),sorts:f},e.field))}),v.length>0&&a(`div`,{className:`cantal-header-unpinned`,style:D,children:P(v.slice(h,m+1)).map(e=>a(j,{classNames:typeof e.headerCellClassNames==`function`?e.headerCellClassNames({columnDef:e,position:u.get(e)}):e.headerCellClassNames,columnDef:e,filterer:e.filterer,filters:n,handleFilter:r,handleResize:b,handleSort:c,position:u.get(e),sorts:f},e.field))}),y.length>0&&a(`div`,{className:`cantal-header-pinned-end`,style:O,children:P(y).map(e=>a(j,{classNames:typeof e.headerCellClassNames==`function`?e.headerCellClassNames({columnDef:e,position:u.get(e)}):e.headerCellClassNames,columnDef:e,filterer:e.filterer,filters:n,handleFilter:r,handleResize:b,handleSort:c,position:u.get(e),sorts:f},e.field))})]}):a(i,{children:P(l.slice(h,m+1)).map(e=>a(j,{classNames:typeof e.headerCellClassNames==`function`?e.headerCellClassNames({columnDef:e,position:u.get(e)}):e.headerCellClassNames,columnDef:e,filterer:e.filterer,filters:n,handleFilter:r,handleResize:b,handleSort:c,position:u.get(e),sorts:f},e.field))})})})})}function P(e){let t={},n=[];for(let r of e){for(let e of r.ancestors)t[e.field]||(t[e.field]=!0,n.push(e));n.push(r)}return n}function fe(e,t){let n=e.target;if(n instanceof HTMLElement){let e=n?.closest(`[role="columnheader"]`);return t.reduce((t,n)=>{let r=e?.getAttribute(`data-${n}`);return r!=null&&(t[pe(n)]=r),t},{})}return{}}function pe(e){return e.split(`-`).map((e,t)=>t===0?e:e.at(0)?.toUpperCase()+e.slice(1)).join(``)}function F(e,t){for(let n of e){if(n.field===t)return n;if(n.subcolumns&&n.subcolumns.length>0){let e=F(n.subcolumns,t);if(e)return e}}}function I(e,t){return e.hasOwnProperty(t)}function L({className:e,field:t,handleFilter:n,placeholder:r=``,styles:i={},value:o=``}){return a(`input`,{className:e,onChange:e=>n(t,e.target.value),placeholder:r,style:i,type:`search`,value:o})}function R({handleChange:t,selectInitialValue:r=!0,style:i={},type:o=`text`,value:s=``}){let c=n(null);e(()=>{c.current&&(r&&c.current.select(),c.current.focus())},[]);function l(e){[`Enter`,`Tab`,`Escape`].includes(e.key)||e.stopPropagation()}return a(`input`,{onChange:e=>t(e.target.value),onKeyDown:l,ref:c,style:{border:0,borderRadius:0,boxSizing:`border-box`,fontSize:14,height:`100%`,outline:`none`,padding:`0px 4px`,width:`100%`,...i},type:o,value:s})}function z({body:e=(e,t,n,r,i,o,s,c,p)=>a(d,{canvasWidth:s,columnGap:typeof h==`number`?h:h.columnGap,columnSpans:l,containerHeight:o,data:u,editCell:f,focusedCell:m,handleContextMenu:g,handleEdit:v,handleEditCellChange:y,handleFocusedCellChange:b,handleKeyDown:ee,handlePointerDown:te,handleDoublePointerDown:_,handleScroll:w,handleSelection:T,headerViewportRef:c,leafColumns:e,overscanColumns:ne,overscanRows:k,positions:t,rowGap:typeof h==`number`?h:h.rowGap,rowHeight:re,rowId:ie,selectedRanges:ae,selectionFollowsFocus:oe,setState:p,showSelectionBox:se,styles:i,virtual:M,visibleColumnEnd:r,visibleColumnStart:n}),columnDefs:i,columnSorts:s={},columnSpans:l,data:u,editCell:f,filters:p={},focusedCell:m,gap:h={columnGap:1,rowGap:1},handleContextMenu:g=G,handleDoublePointerDown:_=K,handleEdit:v=G,handleEditCellChange:y=G,handleFocusedCellChange:b=G,handleFilter:x=G,handleHeaderPointerDown:S=K,handleKeyDown:ee=K,handlePointerDown:te=K,handleResize:C=G,handleScroll:w=G,handleSelection:T,handleSort:E=G,header:D=(e,t,n,r,i,o,c,l)=>a(de,{canvasWidth:l,columnDefs:e,filters:p,handleFilter:x,handlePointerDown:S,handleResize:C,handleSort:E,leafColumns:t,positions:n,ref:c,sorts:s,styles:o,visibleColumnEnd:i,visibleColumnStart:r}),id:O,overscanColumns:ne=3,overscanRows:k=3,ref:A,rowHeight:re,rowId:ie,selectedRanges:ae=[],selectionFollowsFocus:oe,showSelectionBox:se,styles:j,virtual:M=!1}){let ce=n(null),le=n(null),[ue,N]=r(0),[P,fe]=r(0);t(A,()=>({copy:c}));let pe=e=>{let t=new ResizeObserver(([e])=>{e&&fe(Math.ceil(e.contentRect.height))});return e!==null&&t.observe(e),()=>{t.disconnect()}},{columnGap:F,rowGap:I}=typeof h==`number`?{columnGap:h,rowGap:h}:h,L=ge(i,he);process.env.NODE_ENV;let R=H(L),[z,B]=r(()=>M===!0||M===`columns`?Math.min(R.length,window.innerWidth/me):R.length),V=_e(R),W=U(V,ve(R)),xe=ye(V),Se=be(V,F),Ce={columnGap:F,gridTemplateColumns:xe,rowGap:I},J={...ae.length>0?{WebkitUserSelect:`none`,userSelect:`none`}:{},...j?.container};return o(`div`,{className:`cantal`,id:O,ref:q(ce,pe),style:J,children:[D(L,V,W,ue,z,{...Ce,gridAutoRows:`minmax(27px, auto)`},le,Se),e(V,W,ue,z,{computed:Ce,user:j},P,Se,le,{setVisibleEndColumn:B,setVisibleStartColumn:N})]})}const me=100,he={allowEditCellOverflow:!1,ariaCellLabel:({columnIndex:e,data:t,def:n,rowIndex:r,value:i})=>`Column ${e+1}${typeof n.pinned==`string`&&[`start`,`end`].includes(n.pinned)?`, pinned`:``}${n.title?`, ${n.title}`:``}`,ariaHeaderCellLabel:({def:e,position:t})=>`Column ${t.columnIndex}, ${t.ancestors.map(e=>e.title).filter(e=>typeof e==`string`?e.trim()!==``:!1).concat([e.title]).join(` `)}`,editable:!1,editor:()=>R,filterer:L,minWidth:70,rowSpanComparator:(e,t)=>e===t,rowSpanning:!1,sortStates:[{label:`unsorted`,symbol:`↑↓`,iterable:!1},{label:`ascending`,symbol:`↑`,iterable:!0},{label:`descending`,symbol:`↓`,iterable:!0}],subcolumns:[],valueParser:e=>e,valueRenderer:e=>e.value,width:100};function ge(e,t){let{minWidth:n,width:r,...i}=t;return e.map(e=>{let n=t;return e.subcolumns&&e.subcolumns.length>0&&(n=i,e.subcolumns=ge(e.subcolumns,t)),{...n,...e}})}function B(e,t){return e===void 0?t:e.field===t.field?Object.assign({},t,e):Object.assign({},he,{ancestors:[],pinned:t.pinned},e)}function V(e){return H(ge(e,he))}function H(e,t=[]){return e.map(e=>{if(e.subcolumns&&e.subcolumns.length>0){let n=[...t,e];return H(e.subcolumns,n)}if(t.length>0){let n=t.at(-1);if(n?.subcolumns?.some(t=>t.pinned!==e.pinned))return{...e,ancestors:t.toSpliced(-1,1,{...n,subcolumns:n.subcolumns.filter(t=>t.pinned===e.pinned)})}}return{...e,ancestors:t}}).flat()}function _e(e){return e.toSorted((e,t)=>e.pinned===t.pinned?0:e.pinned===`start`?-1:e.pinned===`end`||e.pinned===void 0&&t.pinned===`start`?1:e.pinned===void 0&&t.pinned===`end`?-1:0)}function ve(e){return e.reduce((e,t)=>Math.max(e,t.ancestors.length+1),1)}function U(e,t){let n=new WeakMap,r=1,i=1,a;for(let o of e){r>1&&a!==o.pinned&&(i=1);for(let e=0;e<o.ancestors.length;e++){let t=o.ancestors[e];if(!t)continue;let a=o.ancestors.slice(0,e);n.get(t)||n.set(t,{ancestors:a,columnIndex:r,columnIndexEnd:r+(t.subcolumns?.length??0),field:t.field,depth:e+1,level:e,pinnedIndex:i,pinnedIndexEnd:i+(t.subcolumns?.length??0),subcolumnIndex:a.at(-1)?.subcolumns?.findIndex(e=>e.field===t.field)??0})}n.set(o,{ancestors:o.ancestors,columnIndex:r,columnIndexEnd:r,depth:t,field:o.field,level:o.ancestors.length,pinnedIndex:i,pinnedIndexEnd:i+1,subcolumnIndex:o.ancestors.at(-1)?.subcolumns?.findIndex(e=>e.field===o.field)??0}),a=o.pinned,i++,r++}return n}function ye(e){return e.map(e=>e.width?`${Math.max(e.width,e.minWidth)}px`:`100px`).join(` `)}function be(e,t){let n=W(e.length-1,e,t);return n?`${n}px`:`auto`}function W(e,t,n){let r=xe(e+1,t,n);return r===null?null:r-n}function xe(e,t,n){let r=t?.slice(0,e).map(e=>Number.isInteger(e.width)?e.width:null).reduce((e,t)=>e===null||t===null?null:e+t,0);return r==null?null:r+e*n}function Se(e,t){if(e.length===0)return 0;let n=e.reduce((e,t)=>e+t.width,0);return t*e.length+n}function G(){}function K({defaultHandler:e}){return e()}function q(...e){return t=>{e.forEach(e=>{typeof e==`function`?e(t):e!=null&&(e.current=t)})}}export{z as Grid,V as getLeafColumns};